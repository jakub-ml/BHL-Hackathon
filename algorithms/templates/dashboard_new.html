{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard pogodowy z mapą</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Layout */
    body { font-family: Arial, sans-serif; margin: 20px; }
    .main-container { display: flex; gap: 24px; align-items: flex-start; justify-content: center; width: 100%; }

    /* Left column: map */
    .map-col { flex: 1 1 60%; min-width: 300px; }
    #map { height: 600px; width: 100%; border: 2px solid #ccc; border-radius: 12px; }

    /* Right column: results */
    .results-col { flex: 0 1 36%; min-width: 260px; max-width: 480px; }
    .report { background:#f0fdf4; padding:20px; border-radius:10px; margin:0; border:1px solid #bbf7d0; }

    .cta-primary{ display:inline-block; padding:14px 26px; font-size:1.05em; background: linear-gradient(45deg,#28a745,#2ecc71); color:#fff; border-radius:12px; border:none; cursor:pointer; text-decoration:none; }

    /* Item styles inside report */
    ul.pred-list { list-style:none; padding:0; margin:12px 0 0 0; }
    ul.pred-list li { margin-bottom:10px; padding:8px; border-radius:6px; background:#fff; border:1px solid #e6f4ea; transition: box-shadow 0.15s ease, transform 0.15s ease; }
    ul.pred-list li.hovered { box-shadow: 0 6px 16px rgba(0,0,0,0.12); transform: translateY(-3px); background: #eafff1; }

    .form-row { display:flex; gap:10px; flex-direction:column; margin-bottom:12px; }
    .form-row label { font-weight:600; margin-bottom:6px; }
    .form-row input { padding:8px 10px; border-radius:8px; border:1px solid #d1e7dd; }

    /* Responsive: stack on small screens */
    @media (max-width: 900px) {
      .main-container { flex-direction: column; align-items: stretch; }
      #map { height: 420px; }
      .results-col { max-width: none; }
    }
  </style>
</head>
<body>

  <div class="main-container">
    <!-- MAP COLUMN -->
    <div class="map-col">
      <div id="map"></div>
    </div>

    <!-- RESULTS COLUMN -->
    <div class="results-col">
      <div class="report">
        <h2 style="margin-top:0;">Analiza Zakończona!</h2>

        <!-- AI form: użytkownik poda parametry modelu i rozmiar zbioru danych -->
        <form id="ai-form" style="margin-bottom:12px;">
          <div class="form-row">
            <label for="modelParams">Liczba parametrów modelu (w mln)</label>
            <input id="modelParams" name="modelParams" type="number" placeholder="np. 7000" required />
          </div>
          <div class="form-row">
            <label for="datasetGB">Wielkość zbioru danych (GB)</label>
            <input id="datasetGB" name="datasetGB" type="number" placeholder="np. 500" required />
          </div>

          <div style="text-align: center; margin-top: 10px;">
            <button id="analyzeBtn" type="submit" class="cta-primary" style="width: 100%;">Analizuj</button>
          </div>
        </form>

        <p style="margin-bottom:8px;">Podsumowanie emisji (posortowane — najmniejsza najpierw):</p>

       <ul class="pred-list">
          {% if prediction %}
            {% for p in prediction %}
              <li class="pred-item" data-location-id="{{ p.weather_log.location.id }}">
                <strong>Miejsce:</strong> {{ p.weather_log.location.city_name }}<br/>
                <strong>Koszt przewidziany:</strong> <span class="base-pred">{{ p.prediction|floatformat:2 }}</span>
                <div class="computed" style="margin-top:6px; font-weight:600; color:#0f5132; display:none;">
                  Obliczone: <span class="computed-val"></span>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li>Brak predykcji w bazie.</li>
          {% endif %}
        </ul>

        <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="cta-primary" href="/algorithms/weather/">Rozpocznij Nową Analizę</a>
          <button class="cta-primary" id="zoomAllBtn" type="button">Pokaż wszystkie markery</button>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #e6f4ea;" />
        <p style="font-size:0.9em; margin:0;">Najedź na wiersz z wynikami aby podświetlić odpowiadający mu pin na mapie. Po podaniu parametrów możesz przemnożyć wartości predykcji przez parametry modelu i rozmiar zbioru — wynik pojawi się obok każdego wiersza oraz w popupie markera.</p>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
   // --- Funkcja pomocnicza: formatowanie liczby dla PL (2 miejsca po przecinku)
function formatPL(value) {
  return Number(value).toLocaleString('pl-PL', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
}

// Pobieramy elementy formularza i listy
const modelInput = document.getElementById('modelParams');
const datasetInput = document.getElementById('datasetGB');
const aiForm = document.getElementById('ai-form');
const items = document.querySelectorAll('.pred-item');

// Funkcja która liczy i aktualizuje UI (dla wszystkich wierszy)
function calculateAndUpdateUI() {
  const modelParamsMillion = Number(modelInput.value);
  const datasetGB = Number(datasetInput.value);

  if (!modelParamsMillion || !datasetGB) {
    // jeśli brak wartości - ukryj pola computed
    items.forEach(it => {
      const computedDiv = it.querySelector('.computed');
      if (computedDiv) computedDiv.style.display = 'none';
    });
    return;
  }

  const factor = modelParamsMillion * datasetGB;

  items.forEach(it => {
    const locIdRaw = it.getAttribute('data-location-id');
    const locId = Number(locIdRaw);
    const idKey = isNaN(locId) ? locIdRaw : locId;

    const baseSpan = it.querySelector('.base-pred');
    const computedDiv = it.querySelector('.computed');
    const computedValSpan = it.querySelector('.computed-val');

    if (!baseSpan) return;
    // zamień przecinek na kropkę jeśli ktoś wkleił lokalny format
    const baseText = baseSpan.textContent.trim().replace(',','.');
    const baseVal = Number(baseText);

    if (!isNaN(baseVal)) {
      const computed = baseVal * factor;
      const formatted = formatPL(computed);

      if (computedValSpan) computedValSpan.textContent = formatted;
      if (computedDiv) computedDiv.style.display = 'block';

      // aktualizuj popup markera, jeśli istnieje
      const marker = markersById[idKey];
      if (marker) {
        const locObj = locations.find(l => (String(l.id) === String(idKey) || String(l.pk) === String(idKey)));
        const cityName = locObj ? locObj.city_name : '';
        let popupHtml = `<strong>${cityName}</strong>`;
        popupHtml += `<br/><em>Predykcja:</em> ${Number(baseVal).toFixed(2)}`;
        popupHtml += `<br/><em>Obliczone (p*m):</em> ${formatted}`;
        if (marker.getPopup()) {
          marker.getPopup().setContent(popupHtml);
        } else {
          marker.bindPopup(popupHtml);
        }
      }
    } else {
      if (computedDiv) computedDiv.style.display = 'none';
    }
  });
}

// submit formularza (zachowuje dotychczasową logikę, ale uruchamia też update UI)
aiForm.addEventListener('submit', (e) => {
  e.preventDefault();
  calculateAndUpdateUI();
});

// live update: reagujemy podczas wpisywania
modelInput.addEventListener('input', () => calculateAndUpdateUI());
datasetInput.addEventListener('input', () => calculateAndUpdateUI());

// opcjonalnie: jeśli chcesz żeby wartości były przeliczone od razu po załadowaniu (jeśli inputy mają defaulty)
window.addEventListener('load', () => {
  if (modelInput.value && datasetInput.value) calculateAndUpdateUI();
});
  </script>
</body>
</html>
